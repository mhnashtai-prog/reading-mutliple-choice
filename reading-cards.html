<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reading Cards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: linear-gradient(135deg,#2c5aa0 0%,#f5a9ba 100%);
      font-family: 'Inter', 'Montserrat', Arial, sans-serif;
      margin:0;
      min-height: 100vh;
    }
    .container {
      max-width: 720px;
      margin:0 auto;
      padding:24px 1vw 70px 1vw;
    }
    h1 {
      text-align: center;
      color: #fff;
      font-size:2.25rem;
      letter-spacing: 0.04em;
      font-family: 'Montserrat', Arial, sans-serif;
    }
    /* Metro/choices/card style */
    .card { background: #f7f8fa; border-radius:20px; box-shadow:0 14px 18px -8px rgba(83,89,100,0.13); padding:20px 18px 32px 18px; margin-bottom:30px; position:relative; }
    #metroLabels {
      margin: 38px auto 0 auto;
      max-width: 640px;
      display:flex;
      flex-direction:column;
      gap:7px;
    }
    .metro-label-link, .choice {
      display: block;
      font-size: 1.08rem;
      font-family: 'Montserrat', Arial, sans-serif;
      padding: 15px 0 10px 22px;
      margin-bottom: 14px;
      background: rgba(255,255,255,0.23);
      border-radius: 15px;
      border-left: 9px solid #FFA066;
      color: #1d3355;
      font-weight: 600;
      letter-spacing: .019em;
      box-shadow: 0 5px 38px -12px rgba(120, 89, 180, 0.15), 0 0.5px 2px rgba(71,53,116,0.10);
      backdrop-filter: blur(2px);
      cursor: pointer;
      transition: background .13s, color .13s, border-left-color .18s;
      position: relative;
      overflow: hidden;
      text-decoration: none;
      border: none;
    }
    .metro-label-link::before, .choice::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 7px;
      background: linear-gradient(200deg, #FFA066 30%, #e96443 100%);
      border-radius: 10px 0 0 10px;
      z-index: 2;
      transition: background .17s;
    }
    .metro-label-link:hover, .choice:hover {
      background: rgba(255,255,240,0.45);
      color: #bd6732;
      border-left-color: #e96443;
    }
    .metro-label-link.done, .choice.selected, .choice:active  {
      background: rgba(194,248,180, 0.44);
      color: #275216;
      border-left-color: #93c560;
    }
    .metro-label-link.done::before, .choice.selected::before, .choice:active::before {
      background: linear-gradient(210deg, #93c560 40%, #41e3ce 100%);
    }
    .metro-label-link.active {
      border-left-color: #3C61E3;
      background: rgba(106,203,250, 0.20);
    }
    .metro-label-link.active::before {
      background: linear-gradient(210deg,#3C61E3 33%, #FFB66F 100%);
    }
    .text-box {
      margin-bottom: 36px;
      color: #222;
      line-height: 1.58;
      font-size: 1rem;
    }
    .question-title { font-size: 1.03rem; margin-bottom: 15px; color: #2a3e66; font-weight: 500; }
    .choices { display: flex; flex-direction: column; gap: 2px; margin-bottom: 7px;}
    .highlighted { background: #93C560; color: #181c2e; border-radius: 4px; padding: 0 2px;}
    .feedback { margin-top: 8px; font-size: 1em; color: #c72c2c; min-height: 18px; }
    .card-actions { margin-top: 10px; display: flex; gap: 10px;}
    .card-btn { background: #93C560; color: #fff; border: none; border-radius: 12px; font-size: 1em; padding: 8px 18px; cursor: pointer; transition: background 0.13s; font-family: inherit;}
    .card-btn:active { background: #bfd58e; }
    .card-btn:disabled { background: #b8d3ea; cursor: default; opacity: 0.7; }
    .footer { background: #222; color:#fff; font-weight:600; max-width:670px; margin:0 auto; padding:13px 20vw 13px 18px; text-align:center; font-size:1.13rem; position:fixed; left:50%; bottom:0; transform:translateX(-50%); width:99vw; border-radius: 18px 18px 0 0; z-index:15; display:flex;align-items:center;justify-content:center;}
    .footer-btn { background: none; color:#fff; border:none; font-size:1.05rem; font-weight:600; margin-left:18px; margin-right:8px; cursor:pointer; display:flex;align-items:center;}
    .footer-btn .arrow { font-size:1.45em; margin-right:7px; }
    @media (max-width:700px){
      .footer {font-size: 0.99rem;}
    }
    @media (max-width:440px){
      #metroLabels, .container {font-size:0.99em;margin-top:28px;}
      h1{font-size:1.2em;}
      .footer{font-size: 0.95rem;}
    }
    .metro-label-link { text-decoration: none; }
    .metro-label-link:visited { color: inherit; }
  </style>
</head>
<body>
<div id="app">
  <div class="container">
    <h1 style="color:white;text-align:center;">Loading...</h1>
  </div>
</div>
<script>
function getQueryParam(name) {
  let match = location.search.match(new RegExp("[?&]"+name+"=([^&]*)"));
  return match && decodeURIComponent(match[1]);
}
let testId = getQueryParam('test');
function setPassageCompleted(passageId) {
  let prog = {};
  try { prog = JSON.parse(localStorage.getItem("readingMetroProgress")||"{}"); } catch(e){ prog = {}; }
  prog[passageId] = true;
  localStorage.setItem("readingMetroProgress", JSON.stringify(prog));
}
fetch("fetchfiles-reading-texts.json")
  .then(r=>r.json())
  .then(data=>{
    let manifest = data.find(item=>item.id===testId);
    if (!manifest) { 
      document.getElementById('app').innerHTML = "<div class='container'><h1 style='color:white;text-align:center;'>Test not found: " + testId + "</h1></div>"; 
      return;
    }
    return fetch(manifest.file).then(r=>r.json());
  })
  .then(data=>{
    if (!data) return;
    renderCards(data);
  })
  .catch(err=>{
    console.error(err);
    document.getElementById('app').innerHTML = "<div class='container'><h1 style='color:white;text-align:center;'>Error: " + err.message + "</h1></div>";
  });
function renderCards(data) {
  let html = `
    <div class="container">
      <div class="title">${data.title||'Test'}</div>
      <div class="subtitle">${data.subtitle||''}</div>
      <div class="divider"></div>
      ${data.cards.map((card,i)=>`
      <div class="card" data-idx="${i}">
        <div class="text-box">
          ${card.text.replace(card.highlight, `<span id="ref-${i}">${card.highlight}</span>`)}
        </div>
        <div class="question-title">${card.question}</div>
        <div class="choices">
          ${card.choices.map((c,j)=>`
            <div class="choice" data-answer="${String.fromCharCode(65+j)}">${String.fromCharCode(65+j)}. ${c}</div>
          `).join("")}
        </div>
        <div class="feedback" id="feedback-${i}"></div>
        <div class="card-actions">
          <button class="card-btn" onclick="showAnswer(${i})">Show</button>
          <button class="card-btn" onclick="repeatQ(${i})">Repeat</button>
          ${i < data.cards.length-1 ? `<button class="card-btn" onclick="nextQ(${i})">Next</button>` : ""}
        </div>
      </div>
      `).join("")}
    </div>
    <div class="footer">
      <span>Score: <span id="score">0</span> / ${data.cards.length}</span>
      <button class="footer-btn" onclick="window.location.href='index.html'"><span class="arrow">‚Üê</span> RETURN</button>
    </div>
  `;
  document.getElementById('app').innerHTML = html;
  const correctAnswers = data.cards.map((card)=>String.fromCharCode(65+(card.answer || 0)));
  let scores = Array(data.cards.length).fill(0);
  let answered = Array(data.cards.length).fill(false);
  function checkAllAnswered() {
    if (answered.every(x=>x)) {
      setPassageCompleted(testId);
    }
  }
  document.querySelectorAll('.card').forEach((card,idx) => {
    card.querySelectorAll('.choice').forEach(choice => {
      choice.onclick = () => {
        if (answered[idx]) return;
        card.querySelectorAll('.choice').forEach(c => c.classList.remove('selected'));
        choice.classList.add('selected');
        let val = choice.getAttribute('data-answer');
        let ref = document.getElementById('ref-'+idx);
        let fb = document.getElementById('feedback-'+idx);
        if (val === correctAnswers[idx]) {
          fb.textContent = "";
          if (ref) ref.classList.add('highlighted');
          scores[idx]=1;
        } else {
          fb.textContent = "There is no reference in the text.";
          if (ref) ref.classList.remove('highlighted');
          scores[idx]=0;
        }
        answered[idx]=true;
        document.getElementById('score').textContent=scores.reduce((a,b)=>a+b,0);
        checkAllAnswered();
      };
    });
  });
  window.showAnswer = function(idx) {
    let card = document.querySelector('.card[data-idx="'+idx+'"]');
    let correct = correctAnswers[idx];
    card.querySelectorAll('.choice').forEach(c => {
      if (c.getAttribute('data-answer')===correct) c.classList.add('selected');
    });
    let ref = document.getElementById('ref-'+idx);
    if (ref) ref.classList.add('highlighted');
    document.getElementById('feedback-'+idx).textContent = '';
    scores[idx]=1; answered[idx]=true;
    document.getElementById('score').textContent=scores.reduce((a,b)=>a+b,0);
    checkAllAnswered();
  };
  window.repeatQ = function(idx) {
    answered[idx]=false; scores[idx]=0;
    let card = document.querySelector('.card[data-idx="'+idx+'"]');
    let ref = document.getElementById('ref-'+idx);
    if (ref) ref.classList.remove('highlighted');
    document.getElementById('feedback-'+idx).textContent = '';
    card.querySelectorAll('.choice').forEach(c => c.classList.remove('selected'));
    document.getElementById('score').textContent=scores.reduce((a,b)=>a+b,0);
  };
  window.nextQ = function(idx) {
    let nextCard = document.querySelector('.card[data-idx="'+(idx+1)+'"]');
    if(nextCard) nextCard.scrollIntoView({behavior:'smooth',block:'start'});
  };
}
</script>
</body>
</html>
