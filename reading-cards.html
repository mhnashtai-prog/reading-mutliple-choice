<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reading Cards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500|Montserrat:400,500,700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg,#2c5aa0 0%,#f5a9ba 100%);
      font-family: 'Inter', 'Montserrat', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 1vw 70px 1vw;
    }
    
    h1 {
      text-align: center;
      color: #fff;
      font-size: 2rem;
      letter-spacing: 0.02em;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 500;
      margin-bottom: 8px;
      text-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .subtitle {
      text-align: center;
      color: rgba(255,255,255,0.85);
      font-size: 1rem;
      margin-bottom: 24px;
      font-weight: 400;
    }
    
    /* Enhanced Card Styling - Fixed CSS */
    .card {
      background: #EDE7EA;
      backdrop-filter: blur(13px) saturate(1.2);
      border: 1.5px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      box-shadow: 0 10px 26px -8px rgba(44,90,160,0.08), 0 1.5px 3px rgba(238,238,238,0.6);
      padding: 14px 12px 16px 14px;
      margin-bottom: 18px;
      transition: all 0.22s ease;
      position: relative;
      animation: fadeInUp 0.4s ease-out;
    }
    
    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px -8px rgba(44,90,160,0.12), 0 2px 4px rgba(238,238,238,0.8);
    }
    
    .text-box {
      margin-bottom: 16px;
      color: #2a2a2a;
      line-height: 1.58;
      font-size: 1rem;
      font-weight: 400;
    }
    
    .question-title {
      font-size: 1.02rem;
      margin-bottom: 10px;
      color: #2442b0;
      font-weight: 500;
    }
    
    /* Enhanced Multiple Choice Styling - Reduced Height */
    .choices {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 10px;
    }
    
    .choice {
      background: #F7F6F7;
      font-size: 0.9rem;
      font-family: 'Inter', 'Montserrat', Arial, sans-serif;
      font-weight: 400;
      padding: 6px 10px;
      min-height: 36px;
      border-radius: 10px;
      border-left: 5px solid #FFA066;
      color: #2a2a2a;
      margin-bottom: 0;
      box-shadow: 0 2px 9px -2px rgba(44,90,160,0.09);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(8px) saturate(1.25);
      line-height: 1.4;
      display: flex;
      align-items: center;
      white-space: normal;
      word-break: break-word;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    .choice::before {
      content: '';
      position: absolute;
      left: 0; 
      top: 0; 
      bottom: 0;
      width: 5px;
      background: linear-gradient(200deg, #FFA066 30%, #e96443 100%);
      border-radius: 8px 0 0 8px;
      z-index: 2;
      transition: background 0.17s;
    }
    
    .choice:hover {
      background: rgba(255,255,255,0.35);
      color: #784621;
      border-left-color: #e96443;
      transform: translateX(2px);
    }
    
    .choice.selected, .choice:active {
      background: linear-gradient(90deg, #eaffba 0%, #bfff00 90%);
      color: #274604;
      border-left-color: #bfff00;
      font-weight: 500;
      box-shadow: 0 4px 14px -2px rgba(191,255,0,0.4);
      transform: translateX(3px);
    }
    
    .choice.selected::before, .choice:active::before {
      background: linear-gradient(210deg, #bfff00 40%, #8cffda 100%);
    }
    
    /* Text Highlighting */
    .highlighted, .highlight-target.highlighted {
      background: linear-gradient(90deg, #daff47 0%, #bfff00 80%) !important;
      color: #16390e !important;
      border-radius: 4px;
      padding: 2px 4px;
      font-weight: 500;
      box-shadow: 0 1px 3px rgba(191, 255, 0, 0.3);
      transition: all 0.2s;
    }
    
    .feedback {
      margin-top: 10px;
      font-size: 0.9em;
      color: #c72c2c;
      min-height: 18px;
      font-weight: 400;
    }
    
    /* Enhanced Button Styling - Reduced Height */
    .card-actions {
      margin-top: 12px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .card-btn {
      background: linear-gradient(135deg, #bfff00 0%, #9fff50 100%);
      color: #214e19;
      border: none;
      border-radius: 10px;
      font-size: 0.85em;
      padding: 6px 12px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(191, 255, 0, 0.2);
      transition: all 0.15s ease;
      font-family: inherit;
      font-weight: 500;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .card-btn:hover {
      background: linear-gradient(135deg, #a8ff00 0%, #85e842 100%);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(191, 255, 0, 0.3);
    }
    
    .card-btn:active {
      background: linear-gradient(135deg, #a8d170 0%, #7fb050 100%);
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(191, 255, 0, 0.4);
    }
    
    .card-btn:disabled {
      background: #cdecce;
      cursor: default;
      opacity: 0.7;
      transform: none;
      box-shadow: none;
    }
    
    /* Enhanced Footer - Reduced Height */
    .footer {
      background: linear-gradient(135deg, #222 0%, #333 100%);
      color: #fff;
      font-weight: 500;
      max-width: 670px;
      margin: 0 auto;
      padding: 10px 16px;
      text-align: center;
      font-size: 0.95rem;
      position: fixed;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: calc(100vw - 32px);
      max-width: 670px;
      border-radius: 12px 12px 0 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
      backdrop-filter: blur(20px);
    }
    
    .footer-btn {
      background: none;
      color: #fff;
      border: none;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.2s;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .footer-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .footer-btn .arrow { 
      font-size: 1.1em; 
      margin-right: 4px; 
    }
    
    /* Mobile Optimizations */
    @media (max-width: 700px) {
      .container { 
        padding: 16px 3vw 80px 3vw; 
        font-size: 0.95em;
      }
      
      .choice { 
        font-size: 0.85rem; 
        padding: 8px 10px;
        min-height: 40px;
      }
      
      .card-btn {
        font-size: 0.8em;
        padding: 8px 12px;
        min-height: 36px;
      }
      
      .footer {
        font-size: 0.9rem;
        padding: 8px 14px;
      }
    }
    
    @media (max-width: 480px) {
      h1 { 
        font-size: 1.7em; 
        margin-bottom: 6px;
      }
      
      .subtitle {
        font-size: 0.9rem;
        margin-bottom: 20px;
      }
      
      .choice { 
        font-size: 0.8rem; 
        padding: 10px 10px;
        min-height: 44px;
      }
      
      .card-actions {
        gap: 4px;
      }
      
      .card-btn {
        font-size: 0.75em;
        padding: 10px 10px;
        min-height: 40px;
        flex: 1;
        min-width: 70px;
      }
      
      .footer {
        font-size: 0.85rem;
        padding: 6px 10px;
        flex-direction: column;
        gap: 2px;
        border-radius: 8px 8px 0 0;
      }
    }

    /* Animations */
    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(20px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    @keyframes slideInRight {
      from { 
        opacity: 0; 
        transform: translateX(-20px); 
      }
      to { 
        opacity: 1; 
        transform: translateX(0); 
      }
    }

    .choice {
      animation: slideInRight 0.3s ease-out;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Loading state */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 50vh;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top: 4px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div id="app">
  <div class="container">
    <div class="loading">
      <div class="spinner"></div>
    </div>
  </div>
</div>

<script>
// Utility Functions
function getQueryParam(name) {
  let match = location.search.match(new RegExp("[?&]"+name+"=([^&]*)"));
  return match && decodeURIComponent(match[1]);
}

function setPassageCompleted(passageId) {
  let prog = {};
  try { 
    prog = JSON.parse(localStorage.getItem("readingMetroProgress")||"{}"); 
  } catch(e){ 
    prog = {}; 
  }
  prog[passageId] = true;
  localStorage.setItem("readingMetroProgress", JSON.stringify(prog));
}

// Enhanced text highlighting function
function highlightTextInHTML(htmlContent, highlightText) {
  if (!highlightText || highlightText.trim() === '') return htmlContent;
  
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  
  function highlightInTextNodes(node, searchText) {
    if (node.nodeType === Node.TEXT_NODE) {
      const text = node.textContent;
      const regex = new RegExp(`(${searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      
      if (regex.test(text)) {
        const highlightedHTML = text.replace(regex, '<span class="highlight-target">$1</span>');
        const wrapper = document.createElement('span');
        wrapper.innerHTML = highlightedHTML;
        node.parentNode.replaceChild(wrapper, node);
      }
    } else if (node.nodeType === Node.ELEMENT_NODE) {
      const children = Array.from(node.childNodes);
      children.forEach(child => highlightInTextNodes(child, searchText));
    }
  }
  
  highlightInTextNodes(tempDiv, highlightText);
  return tempDiv.innerHTML;
}

// Main application logic
let testId = getQueryParam('test');

// Add loading timeout
const loadingTimeout = setTimeout(() => {
  document.getElementById('app').innerHTML = `
    <div class='container'>
      <h1 style='color:white;text-align:center;'>Loading timeout</h1>
      <p style='color:rgba(255,255,255,0.8);text-align:center;'>Please check your connection and try again.</p>
    </div>`;
}, 10000);

fetch("fetchfiles-reading-texts.json")
  .then(r=>r.json())
  .then(data=>{
    clearTimeout(loadingTimeout);
    let manifest = data.find(item=>item.id===testId);
    if (!manifest) { 
      document.getElementById('app').innerHTML = `
        <div class='container'>
          <h1 style='color:white;text-align:center;'>Test not found: ${testId}</h1>
          <p style='color:rgba(255,255,255,0.8);text-align:center;margin-top:20px;'>
            <button onclick="window.location.href='index.html'" style="background:linear-gradient(135deg,#bfff00 0%,#9fff50 100%);color:#214e19;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Return to Menu</button>
          </p>
        </div>`; 
      return;
    }
    return fetch(manifest.file).then(r=>r.json());
  })
  .then(data=>{
    if (!data) return;
    renderCards(data);
  })
  .catch(err=>{
    clearTimeout(loadingTimeout);
    console.error(err);
    document.getElementById('app').innerHTML = `
      <div class='container'>
        <h1 style='color:white;text-align:center;'>Error loading test</h1>
        <p style='color:rgba(255,255,255,0.8);text-align:center;margin-top:20px;'>
          <button onclick="window.location.href='index.html'" style="background:linear-gradient(135deg,#bfff00 0%,#9fff50 100%);color:#214e19;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Return to Menu</button>
        </p>
      </div>`;
  });

function renderCards(data) {
  // Process each card's text content for highlighting
  const processedCards = data.cards.map((card, index) => {
    const processedText = highlightTextInHTML(card.text, card.highlight);
    return {
      ...card,
      processedText: processedText
    };
  });
  
  let html = `
    <div class="container">
      <h1>${data.title||'Reading Comprehension'}</h1>
      ${data.subtitle ? `<div class="subtitle">${data.subtitle}</div>` : ''}
      ${processedCards.map((card,i)=>`
      <div class="card" data-idx="${i}" style="animation-delay: ${i * 0.1}s;">
        <div class="text-box">
          ${card.processedText}
        </div>
        <div class="question-title">${card.question}</div>
        <div class="choices">
          ${card.choices.map((c,j)=>{
            if (!c || c.trim() === '') return '';
            return `<div class="choice" data-answer="${String.fromCharCode(65+j)}" data-card="${i}" style="animation-delay: ${(i * 0.1) + (j * 0.05)}s;">${String.fromCharCode(65+j)}. ${c}</div>`;
          }).join("")}
        </div>
        <div class="feedback" id="feedback-${i}"></div>
        <div class="card-actions">
          <button class="card-btn" data-action="show" data-card="${i}">Show Answer</button>
          <button class="card-btn" data-action="repeat" data-card="${i}">Try Again</button>
          ${i < data.cards.length-1 ? `<button class="card-btn" data-action="next" data-card="${i}">Next Question</button>` : ''}
        </div>
      </div>
      `).join("")}
    </div>
    <div class="footer">
      <span>Score: <span id="score">0</span> / ${data.cards.length}</span>
      <button class="footer-btn" data-action="return"><span class="arrow">←</span> Return to Menu</button>
    </div>
  `;
  
  document.getElementById('app').innerHTML = html;
  
  // Initialize quiz logic
  initializeQuiz(data);
}

function initializeQuiz(data) {
  const correctAnswers = data.cards.map((card)=>String.fromCharCode(65+(card.answer || 0)));
  let scores = Array(data.cards.length).fill(0);
  let answered = Array(data.cards.length).fill(false);
  
  function updateScore() {
    document.getElementById('score').textContent = scores.reduce((a,b)=>a+b,0);
  }
  
  function checkAllAnswered() {
    if (answered.every(x=>x)) {
      setPassageCompleted(testId);
    }
  }
  
  function highlightCorrectText(cardIndex) {
    const card = document.querySelector(`.card[data-idx="${cardIndex}"]`);
    const highlights = card.querySelectorAll('.highlight-target');
    highlights.forEach(highlight => {
      highlight.classList.add('highlighted');
    });
  }
  
  function removeHighlight(cardIndex) {
    const card = document.querySelector(`.card[data-idx="${cardIndex}"]`);
    const highlights = card.querySelectorAll('.highlight-target');
    highlights.forEach(highlight => {
      highlight.classList.remove('highlighted');
    });
  }
  
  // Enhanced event handling with better performance
  document.addEventListener('click', function(e) {
    // Handle choice selection
    if (e.target.classList.contains('choice')) {
      e.preventDefault();
      e.stopPropagation();
      
      const cardIndex = parseInt(e.target.dataset.card);
      
      if (answered[cardIndex]) return;
      
      // Add selection animation
      e.target.style.transform = 'scale(0.98)';
      setTimeout(() => {
        e.target.style.transform = '';
      }, 100);
      
      // Clear previous selections
      const card = document.querySelector(`.card[data-idx="${cardIndex}"]`);
      card.querySelectorAll('.choice').forEach(c => c.classList.remove('selected'));
      
      // Select current choice
      e.target.classList.add('selected');
      
      const selectedAnswer = e.target.dataset.answer;
      const feedback = document.getElementById(`feedback-${cardIndex}`);
      
      if (selectedAnswer === correctAnswers[cardIndex]) {
        feedback.textContent = "";
        feedback.style.color = "#2d7016";
        highlightCorrectText(cardIndex);
        scores[cardIndex] = 1;
      } else {
        feedback.textContent = "There is no reference in the text for this answer.";
        feedback.style.color = "#c72c2c";
        removeHighlight(cardIndex);
        scores[cardIndex] = 0;
      }
      
      answered[cardIndex] = true;
      updateScore();
      checkAllAnswered();
      return;
    }
    
    // Handle button clicks
    if (e.target.classList.contains('card-btn') || e.target.closest('.card-btn')) {
      e.preventDefault();
      e.stopPropagation();
      
      const button = e.target.classList.contains('card-btn') ? e.target : e.target.closest('.card-btn');
      const action = button.dataset.action;
      const cardIndex = parseInt(button.dataset.card);
      
      // Add button press animation
      button.style.transform = 'scale(0.96)';
      setTimeout(() => {
        button.style.transform = '';
      }, 100);
      
      switch(action) {
        case 'show':
          showAnswer(cardIndex);
          break;
        case 'repeat':
          repeatQuestion(cardIndex);
          break;
        case 'next':
          nextQuestion(cardIndex);
          break;
      }
      return;
    }
    
    // Handle footer button
    if (e.target.classList.contains('footer-btn') || e.target.closest('.footer-btn')) {
      e.preventDefault();
      window.location.href = 'index.html';
      return;
    }
  });
  
  function showAnswer(cardIndex) {
    const card = document.querySelector(`.card[data-idx="${cardIndex}"]`);
    const correctAnswer = correctAnswers[cardIndex];
    
    // Clear previous selections
    card.querySelectorAll('.choice').forEach(c => c.classList.remove('selected'));
    
    // Select correct answer with animation
    const correctChoice = card.querySelector(`.choice[data-answer="${correctAnswer}"]`);
    if (correctChoice) {
      setTimeout(() => {
        correctChoice.classList.add('selected');
      }, 100);
    }
    
    // Show highlighting and clear feedback
    highlightCorrectText(cardIndex);
    const feedback = document.getElementById(`feedback-${cardIndex}`);
    feedback.textContent = '';
    feedback.style.color = "#2d7016";
    
    scores[cardIndex] = 1;
    answered[cardIndex] = true;
    updateScore();
    checkAllAnswered();
  }
  
  function repeatQuestion(cardIndex) {
    answered[cardIndex] = false;
    scores[cardIndex] = 0;
    
    const card = document.querySelector(`.card[data-idx="${cardIndex}"]`);
    removeHighlight(cardIndex);
    
    const feedback = document.getElementById(`feedback-${cardIndex}`);
    feedback.textContent = '';
    
    card.querySelectorAll('.choice').forEach(c => c.classList.remove('selected'));
    updateScore();
  }
  
  function nextQuestion(cardIndex) {
    const nextCard = document.querySelector(`.card[data-idx="${cardIndex + 1}"]`);
    if (nextCard) {
      nextCard.scrollIntoView({
        behavior: 'smooth',
        block: 'start',
        inline: 'nearest'
      });
    }
  }

  // Add swipe navigation for mobile
  let startX = 0;
  let startY = 0;
  
  document.addEventListener('touchstart', function(e) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  });
  
  document.addEventListener('touchend', function(e) {
    if (!startX || !startY) return;
    
    let endX = e.changedTouches[0].clientX;
    let endY = e.changedTouches[0].clientY;
    
    let diffX = startX - endX;
    let diffY = startY - endY;
    
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
      if (diffX > 0) {
        // Swipe left - next card if available
        const currentCard = document.querySelector('.card:hover') || document.querySelector('.card');
        if (currentCard) {
          const nextCard = currentCard.nextElementSibling;
          if (nextCard && nextCard.classList.contains('card')) {
            nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }
      }
    }
    
    startX = 0;
    startY = 0;
  });
}
</script>
</body>
</html>
